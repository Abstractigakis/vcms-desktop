<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIVCMS - Vault</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="header vault-header">
      <div class="header-left">
        <button class="back-button" onclick="goBack()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"
            />
          </svg>
          Back
        </button>
        <div>
          <div class="vault-title" id="vaultName">Loading...</div>
          <div class="vault-path" id="vaultPath">Loading...</div>
        </div>
      </div>
      <div class="header-right">
        <button class="action-btn" onclick="refreshVault()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"
            />
          </svg>
          Refresh
        </button>
      </div>
    </div>

    <div class="main-content vault-layout">
      <div class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-title">Files</div>
          <input
            type="text"
            class="search-box"
            placeholder="Search files..."
            id="searchBox"
            oninput="filterFiles()"
          />
        </div>
        <div class="file-list" id="fileList">
          <div class="empty-state compact">
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
              <path
                d="M6 2c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h8l6-6V8l-6-6H6zm7 7V3.5L18.5 9H13z"
              />
            </svg>
            <div>Loading files...</div>
          </div>
        </div>
      </div>

      <div class="content-area">
        <div class="content-body" id="contentBody">
          <div class="welcome-screen">
            <svg class="welcome-icon" viewBox="0 0 24 24" fill="currentColor">
              <path
                d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"
              />
            </svg>
            <div class="welcome-title">Welcome to your vault</div>
            <div class="welcome-subtitle">
              Your vault is ready. Start by creating your first note or
              document.
            </div>
            <div class="welcome-actions">
              <button class="welcome-btn" onclick="createNewFile()">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                </svg>
                New Note
              </button>
              <button class="welcome-btn" onclick="importFiles()">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z" />
                </svg>
                Import Files
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { ipcRenderer } = require("electron");

      let currentVault = null;
      let files = [];
      let filteredFiles = [];

      async function loadVault() {
        try {
          console.log("Loading vault...");

          // Get current vault from main process
          currentVault = await ipcRenderer.invoke("get-current-vault");
          console.log("Current vault:", currentVault);

          if (currentVault && currentVault.path) {
            document.getElementById("vaultName").textContent =
              currentVault.name;
            document.getElementById("vaultPath").textContent =
              currentVault.path;

            await loadVaultContents();
          } else {
            console.error("No current vault found");
            // Go back to vault selection if no vault is available
            await goBack();
          }
        } catch (error) {
          console.error("Error loading vault:", error);
          await goBack();
        }
      }

      async function loadVaultContents() {
        try {
          const result = await ipcRenderer.invoke(
            "get-vault-contents",
            currentVault.path
          );
          if (result.success) {
            files = result.files;
            filteredFiles = [...files];
            renderFileList();
          } else {
            console.error("Error loading vault contents:", result.error);
          }
        } catch (error) {
          console.error("Error loading vault contents:", error);
        }
      }

      function renderFileList() {
        const fileList = document.getElementById("fileList");

        if (filteredFiles.length === 0) {
          fileList.innerHTML = `
            <div class="empty-state compact">
              <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M6 2c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h8l6-6V8l-6-6H6zm7 7V3.5L18.5 9H13z"/>
              </svg>
              <div>No files found</div>
            </div>
          `;
          return;
        }

        fileList.innerHTML = filteredFiles
          .map(
            (file) => `
          <div class="file-item" onclick="selectFile('${file.path}')">
            <svg class="file-icon" viewBox="0 0 24 24" fill="currentColor">
              ${
                file.isDirectory
                  ? '<path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>'
                  : '<path d="M6 2c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h8l6-6V8l-6-6H6zm7 7V3.5L18.5 9H13z"/>'
              }
            </svg>
            <div class="file-name">${file.name}</div>
          </div>
        `
          )
          .join("");
      }

      function filterFiles() {
        const searchTerm = document
          .getElementById("searchBox")
          .value.toLowerCase();
        filteredFiles = files.filter((file) =>
          file.name.toLowerCase().includes(searchTerm)
        );
        renderFileList();
      }

      function selectFile(filePath) {
        // Remove previous selection
        document.querySelectorAll(".file-item").forEach((item) => {
          item.classList.remove("selected");
        });

        // Add selection to clicked item
        event.target.closest(".file-item").classList.add("selected");

        // Load file content (placeholder)
        document.getElementById("contentBody").innerHTML = `
          <div style="padding: 20px;">
            <h3>File: ${filePath.split("/").pop()}</h3>
            <p style="color: #a0a0a0; margin-top: 10px;">
              File viewing functionality will be implemented here.
            </p>
            <p style="color: #a0a0a0; margin-top: 5px;">
              Path: ${filePath}
            </p>
          </div>
        `;
      }

      async function goBack() {
        await ipcRenderer.invoke("go-back-to-vault-selection");
      }

      async function refreshVault() {
        await loadVaultContents();
      }

      function createNewFile() {
        alert("Create new file functionality will be implemented here");
      }

      function importFiles() {
        alert("Import files functionality will be implemented here");
      }

      // Initialize the vault view
      document.addEventListener("DOMContentLoaded", () => {
        loadVault();
      });
    </script>
  </body>
</html>
